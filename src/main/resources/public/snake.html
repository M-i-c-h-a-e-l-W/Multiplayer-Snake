<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="stylesheet" href="optic.css">
  <!--<script src="snake.js"></script> -->
  <title>Snake Game of MW</title>

  <style>
    html, body {
      height: 100%;
      margin: 0;
    }

    body {
      background: grey;
      display: flex;
      align-items: center;
      justify-content: center;
    }

  </style>
</head>

<body>

<canvas width="1000" height="600" id="canvas" style="border:5px solid #000000;"></canvas>

<script>
    window.onload = initialization();
    var canvas, ctx, playerNr = -1;
    var pause = false;

    function initialization() {
        canvas = document.getElementById("canvas");
        if (canvas.getContext) {
            ctx = canvas.getContext('2d');
            getPosition();

            fetch("http://localhost:8080/api/snake/newPlayer", {
                method: 'GET',
                headers: {'Accept': 'application/json', 'Content-Type': 'application/json'}
            }).then(function (ev) {
                console.log("Erzeugte Snake Klasse ohne JSON:\n\n" + ev.toString());
                ev.json().then(function (snakeClass) {
                    console.log("Erzeugte Snake Klasse:\n\n" + snakeClass.playerNr);
                    playerNr = snakeClass.playerNr;
                });
            }).catch((function (error) {
                console.log("Error: ", error);
            }));

            // Connection Backend & PlayerGetID from Backend
        } else {
            alert("I am sorry, but your browser is bullshit. It does not support the canvas tag.");
        }

    }

    var i = 0;

    function drawSnakes(color, posX, posY) {
        ctx.beginPath();
        //ctx.fillStyle = "rgb(250,0,0)";
        ctx.fillStyle = color;
        var width = 10;
        var height = 10;

        ctx.lineWidth = 2;

        ctx.strokeStyle = "#ffffff";
        ctx.fillRect(posX, posY, width, height);

        ctx.strokeRect(posX, posY, width, height);
        //ctx.clearRect(x,y,width,height);
        ctx.closePath();
    }


    function getPosition() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        drawSnakes("blue", i, 100);

        if (i === 999) {
            i = 0;
        }
        i++;

        document.onkeydown = function (event) {
            var keyCode, changeD = "Error";
            var sendKeyCode = false;

            if (event == null) {
                keyCode = window.event.keyCode;
            } else {
                keyCode = event.keyCode;
            }

            //alert("Eingabe: " + keyCode);
            switch (keyCode) {
                // left
                case 37:
                    changeD = "l";
                    sendKeyCode = true;
                    // action when pressing left key
                    break;
                // up
                case 38:
                    changeD = "o";
                    sendKeyCode = true;
                    // action when pressing up key
                    break;

                // right
                case 39:
                    changeD = "r";
                    sendKeyCode = true;
                    // action when pressing right key
                    break;
                // down
                case 40:
                    changeD = "u";
                    sendKeyCode = true;
                    // action when pressing down key
                    break;
                case 8:
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    // action when pressing down key
                    break;
                case 32:
                    if (!pause) {
                        clearInterval(interval);
                        pause = true;
                    } else {
                        interval = setInterval(getPosition, 10);
                        pause = false;
                    }
                    break;
                default:
                    console.log("Fehlerhafte Eingabe: " + keyCode);
                    break;
            }

            if(sendKeyCode && changeD !== "Error"){
                changeD+= ";" + playerNr.toString();
                //changeD = changeD.toString();
                fetch("http://localhost:8080/api/snake/changeDirection?changeD=" + changeD, {
                    method: 'POST',
                    headers: {'Accept': 'application/json', 'Content-Type': 'application/json'}
                }).then(function (ev) {
                    if(ev.status !== 200){
                        console.log("Errorcode: " + ev.status);
                        console.log("ChangeD ist gleich: " + changeD);
                    }

                }).catch((function (error) {
                    console.log("Error: ", error);
                }));

                changeD = "Error";
                sendKeyCode = false;
            }
        };

    }

    var interval = setInterval(getPosition, 10);
    //setTimeout(getPosition, 5);

function connectWebSocketCHangeDirection() {
    let socket = new WebSocket("ws://localhost:8080/ws");
    let ws = Stomp.over(socket);
    let that = this;
    ws.connect({}, (frame) => {
        ws.subscribe("/snake/changeDirection", (message) => {
            console.log("WebSocket is Connected\nVariable Message: ", message);
            let commentJSONObject = JSON.parse(message.body);
            console.log(commentJSONObject.text);
            insertComment(commentJSONObject.text);

            console.log("TEST: " + message);
        });

        that.webSocket = ws;
    }, function (error) {
        console.log("STOMP error " + error);
        //that.webSocket = null;
    });

}

</script>
<a href="index.html"> Hauptseite</a>

</body>
</html>